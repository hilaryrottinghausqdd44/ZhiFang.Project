<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>设置我的密码</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edgechrome=1">
	<meta name="viewport" content="width=device-width initial-scale=1.0 minimum-scale=1.0 maximum-scale=1.0 user-scalable=0">
	<script type="text/javascript">
		//加载版本号文件
		document.write("<script type='text/javascript' src='../../../../config/version.js?t=" + new Date().getTime() + "'><\/script>");
	</script>
	<link rel="stylesheet" href="../../../../../src/layui/dist/css/layui.css" media="all">
	<link rel="shortcut icon" href="../../../../../../logo-16.png">
</head>
<body>
	<div class="layui-fluid">
		<div class="layui-row layui-col-space15">
			<div class="layui-col-md12">
				<div class="layui-card">
					<div class="layui-card-header">修改密码</div>
					<div class="layui-card-body" pad15>
						<div class="layui-form" lay-filter="form">
							<div class="layui-form-item">
								<label class="layui-form-label">当前密码</label>
								<div class="layui-input-inline">
									<input type="password" name="oldPassword" id="oldPassword" lay-verify="required" lay-verType="tips" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">新密码</label>
								<div class="layui-input-inline">
									<input type="password" name="password" id="password" lay-verify="required|pass" lay-verType="tips" autocomplete="off" class="layui-input">
								</div>
								<div class="layui-form-mid layui-word-aux" id="password_msg">6到16个字符</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">确认新密码</label>
								<div class="layui-input-inline">
									<input type="password" name="repassword" lay-verify="required|repass" lay-verType="tips" autocomplete="off" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">确认新密码</label>
								<div class="layui-input-inline">
									<input type="text" name="ValidateCode" id="ValidateCode" lay-verify="required" placeholder="验证码" class="layui-input">
								</div>
								<div class="layui-form-mid layui-word-aux" style="padding:4px 0!important;">
									<img style="line-height:30px;height:30px;" alt="验证码" id="ValidateCodeImg" />
									<button id="ValidateCodeReferesh" class="layui-btn layui-btn-primary layui-btn-sm" style="padding:0 5px;border:0;">
										<i class="layui-icon layui-icon-refresh-3"></i>
									</button>
								</div>
							</div>
							<div class="layui-form-item">
								<div class="layui-input-block">
									<button class="layui-btn" lay-submit lay-filter="setmypass">确认修改</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="../../../../../src/layui/dist/layui.js"></script>
	<script type="text/javascript">
		UIVersion.getJS('../../../../config/system.js');
	</script>
	<script type="text/javascript">
		layui.extend({
			uxutil:'ux/util',
		}).use(['uxutil','form'],function(){
			var $=layui.$,
				form = layui.form,
				uxutil = layui.uxutil;
				
			//校验用户名密码服务
			var LOGIN_SERVER_URL = uxutil.path.ROOT + '/ServerWCF/RBACService.svc/RBAC_BA_Login?isValidate=true';
			//修改服务地址
			var EDIT_URL = uxutil.path.ROOT + '/ServerWCF/RBACService.svc/RBAC_UDTO_UpdateRBACUserByField';
			//获取验证码图片服务地址
			var GET_VALIDATE_CODE_IMG_URL = uxutil.path.ROOT + '/ServerWCF/RBACService.svc/GetValidateCode';
			//验证码识别服务
			var CHECK_VALIDATE_CODE_URL = uxutil.path.ROOT + '/ServerWCF/RBACService.svc/CheckValidateCode';
			
			//密码强度等级
			var PASSWORD_VALIDATE_TYPE = "V2";
			//密码长度限制
			var PASSWORD_LENGTH = [8,16];
			//密码强度MAP
			var PASSWORD_VALIDATE_MAP = {
				"V1":{
					pwdRegex:new RegExp('(?=.*[0-9])(?=.*[A-Z])(?=.*[a-z])(?=.*[^a-zA-Z0-9])'),
					msg:'密码中必须包含大小写字母、数字、特殊字符，且长度符合8至16位'
				},
				"V2":{
					pwdRegex:new RegExp('(?=.*[0-9])(?=.*[a-zA-Z])(?=.*[^a-zA-Z0-9])'),
					msg:'码中必须包含字母、数字、特殊字符，且长度符合8至16位！'
				},
				"V3":{
					pwdRegex:new RegExp('(?=.*[0-9])(?=.*[a-zA-Z])'),
					msg:'密码中必须包含字母、数字，且长度符合8至16位'
				}
			};
			//密码强度提醒
			$("#password_msg").html(PASSWORD_VALIDATE_MAP[PASSWORD_VALIDATE_TYPE].msg);
			
			//验证码加载
			$("#ValidateCodeImg").attr("src",GET_VALIDATE_CODE_IMG_URL + '?t=' + new Date().getTime());
			$("#ValidateCodeReferesh").on("click",function(){
				$("#ValidateCodeImg").attr("src",GET_VALIDATE_CODE_IMG_URL + '?t=' + new Date().getTime());
			});
			
			//新密码变化监听
			$("#password").on("input propertychange",function(){
				var value = $(this).val();
				if(value){
					var flagClass = '',
						flagColor = '',
						flagHtml = '';
						
					//密码强度检验
					if(checkPasswordStrength(value)){
						flagClass = 'layui-icon-ok-circle';
						flagColor = 'color:#009688;';
					}else{
						flagClass = 'layui-icon-close-fill';
						flagColor = 'color:#FF5722;';
					}
					flagHtml = '<i id="password-flag" class="layui-icon ' + flagClass + 
						'" style="float:right;margin-right:10px;line-height:36px;margin-top:-36px;font-size:24px;' + flagColor + '"></i>';
					
					var flag = $("#password-flag");
					if(flag[0]){
						flag.replaceWith(flagHtml);
					}else{
						$("#password").after(flagHtml);
					}
				}else{
					$("#password-flag").remove();
				}
			});
			
			//当前密码初始获得焦点
			$("#oldPassword").focus();
			form.on("submit(setmypass)",function(obj){
				var field = obj.field,
					oldPassword = field.oldPassword,
					password = field.password,
					repassword = field.repassword;
					
				if(password == ""){
					layer.msg("新密码不能为空!",{time:1000});
					return;
				}
				if(password != repassword){
					layer.msg("两次新密码密码不一致，请重新输入!",{time:1000});
					return;
				}
				if(password == oldPassword){
					layer.msg("新密码与当前密码相同，不需要修改!",{time:1000});
					return;
				}
				
				//密码强度检验
				if(checkPasswordStrength(password)){
					//先验证码识别，通过后再提交登录
					var ValidateCode = $("#ValidateCode").val();
					onCheckValidateCode(ValidateCode,function(){
						isValidate(oldPassword,function(){
							onEdit(password);
						});
					});
				}else{
					var info = PASSWORD_VALIDATE_MAP[PASSWORD_VALIDATE_TYPE];
					var msg = "您的新密码复杂度太低(" + info.msg + ")，请及时修改密码！";
					layer.msg(msg,{time:5000});
				}
				
			});
			//密码强度检验
			function checkPasswordStrength(value){
				var info = PASSWORD_VALIDATE_MAP[PASSWORD_VALIDATE_TYPE];
				var lengthValid = value.length >= PASSWORD_LENGTH[0] && value.length <= PASSWORD_LENGTH[1];
				if (!info.pwdRegex.test(value) || !lengthValid) {
					return false;
				}
				return true;
			};
			//校验用户名密码
			function isValidate(password,callback){
				var url = LOGIN_SERVER_URL + '&strUserAccount=' + uxutil.cookie.get(uxutil.cookie.map.ACCOUNTNAME) + '&strPassWord=' + password;
				uxutil.server.ajax({
					url:url
				},function(result){
					if(result){
						callback();
					}else{
						layer.msg('当前密码错误！',{time:5000});
					}
				});
			};
			//密码修改提交
			function onEdit(password){
				var params = {
					entity:{
						Id:uxutil.cookie.get(uxutil.cookie.map.ACCOUNTID),
						PWD:password
					},
					fields:'Id,PWD'
				};
				uxutil.server.ajax({
					url:EDIT_URL,
					type:'post',
					data:JSON.stringify(params)
				},function(result){
					if(result.success){
						layer.msg('修改成功');
						form.val("form",{
							oldPassword:'',
							password:'',
							repassword:''
						});
					}else{
						layer.msg(result.msg);
					}
				},true);
			};
			//验证码识别
			function onCheckValidateCode(value,callback){
				layer.load();
				uxutil.server.ajax({
					url:CHECK_VALIDATE_CODE_URL,
					cache:false,
					type:'post',
					data:JSON.stringify({
						ValidateCode:value
					})
				},function(data){
					layer.closeAll('loading')
					if(data.success){
						callback();
					}else{
						if(data.ResultCode == '105'){//验证超次数
							layer.msg(data.msg,{time:5000});
						}else{
							layer.msg(data.msg);
						}
					}
				},true);
			};
		});
	</script>
</body>
</html>