Ext.ns("Ext.manage.emprolemodule");Ext.define("Ext.manage.emprolemodule.rolemoduleTree",{extend:'Ext.tree.Panel',alias:'widget.rolemoduleTree',title:'',roleId:'',height:300,selectdChecked:[],isJustOpen:false,selectRecord:null,ClassCode:'BTDAppComponents_ClassCode',linkageType:true,width:260,lines:false,useArrows:true,linkageType:true,isTure:true,rootVisible:false,checked:true,filterBar:'top',functionBar:'top',positionBar:'top',isShowAction:false,isShowCeneral:true,isShowDeleteAlag:false,isFiltration:true,isFunction:true,isbuttonBar:false,isMinusBtn:true,isPlusBtn:true,isreFreshBtn:true,istoolsDelBtn:false,istoolsEditBtn:false,istoolsShowBtn:false,istoolsAddBtn:false,isShowBtn:false,isAddBtn:false,isEditBtn:false,isDelBtn:false,isConfirmBtn:false,isCancelBtn:false,isMenu:false,isDelMenuBtn:false,hideNodeId:null,columnsStr:[{xtype:'treecolumn',text:'中文名称',width:180,sortable:true,dataIndex:'text',triStateSort:false},{text:'描述',dataIndex:'Comment',width:180,sortable:false,hidden:false,hideable:true,align:null},{text:'主键ID',dataIndex:'Id',width:100,sortable:false,hidden:true,hideable:true,align:null},{text:'时间戳',dataIndex:'DataTimeStamp',width:100,sortable:false,hidden:true,hideable:true,align:null},{text:'实验室ID',dataIndex:'LabID',width:100,sortable:false,hidden:true,hideable:true,align:null},{text:'树形结构父级ID',dataIndex:'ParentID',width:100,sortable:false,hidden:true,hideable:true,align:null}],selectServerUrl:getRootPath()+'/'+'RBACService.svc/RBAC_UDTO_SearchRBACModuleToListTree',whereFields:'RBACModule_Comment,RBACModule_Id,RBACModule_DataTimeStamp,RBACModule_LabID,RBACModule_ParentID',autoScroll:true,filterfield:'text',childrenField:'Tree',setParentnode:function(node){var me=this;if(node!=null){if(node.data.tid.toString()=="0"){node.set("checked",false);node.updateInfo({checked:false})}else{if(node.data.tid.toString()!="0"){node.updateInfo({checked:true})}if(node.parentNode==null&&node.data.tid.toString()!="0"){node.updateInfo({checked:true})}else{var parentNode=node.parentNode;if(parentNode!=null){node.parentNode.set("checked",true);this.setParentnode(parentNode)}}}}},parentnode:function(node){var me=this;if(node.parentNode!=null){if(me.nodep(node.parentNode)){node.parentNode.set("checked",true)}else{node.parentNode.set("checked",false)}this.parentnode(node.parentNode)}},chd:function(node,check){node.set("checked",check);if(node.isNode){node.eachChild(function(child){if(node.isLeaf){}else{chd(child,check)}})}},setNodefalse:function(n){var me=this;n.data.checked=false;n.updateInfo({checked:false});var childs=n.childNodes;for(var i=0;i<childs.length;i++){childs[i].data.checked=false;childs[i].updateInfo({checked:false});if(childs[i].data.leaf==false){me.setNodefalse(childs[i])}}},nodep:function(node){var me=this;var bnode=true;Ext.Array.each(node.childNodes,function(v){if(!v.data.checked){bnode=false;return}});return bnode},setNode:function(n){var me=this;n.expand();n.data.checked=true;n.updateInfo({checked:true});var childs=n.childNodes;for(var i=0;i<childs.length;i++){childs[i].data.checked=true;childs[i].updateInfo({checked:true});if(childs[i].data.leaf==false){me.setNode(childs[i])}}},viewConfig:'',getValue:function(){var myTree=this;var arrTemp=myTree.getSelectionModel().getSelection();return arrTemp},internalWhere:'',externalWhere:'',afterRender:function(){var me=this;me.callParent(arguments);if(Ext.typeOf(me.callback)=='function'){me.callback(me)}},createStore:function(where){var me=this;var w='?fields=RBACModule_Comment,RBACModule_Id,RBACModule_DataTimeStamp,RBACModule_LabID,RBACModule_ParentID';var myUrl=me.selectServerUrl+w;var store=Ext.create('Ext.data.TreeStore',{fields:['hasBeenDeleted','Comment','LabID','checked','value','text','expanded','leaf','icon','url','tid','Id','ParentID','DataTimeStamp'],proxy:{type:'ajax',url:myUrl,extractResponseData:function(response){return me.changeStoreData(response)}},defaultRootProperty:me.childrenField,autoLoad:false,root:{text:'所有模块',leaf:false,ParentID:0,Id:0,tid:0,expanded:true},listeners:{load:function(treeStore,node,records,successful,eOpts){var treeToolbar=me.getComponent('treeToolbar');if(treeToolbar==undefined||treeToolbar==''){treeToolbar=me.getComponent('treeToolbarTwo')}if(treeToolbar&&treeToolbar!=undefined){var refresh=treeToolbar.getComponent('refresh');if(refresh&&refresh!=undefined){refresh.disabled=false}}}}});return store},changeStoreData:function(response){var me=this;var data=Ext.JSON.decode(response.responseText);var ResultDataValue=[];if(data.ResultDataValue&&data.ResultDataValue!=''){ResultDataValue=Ext.JSON.decode(data.ResultDataValue)}data[me.childrenField]=ResultDataValue.Tree;var changeNode=function(node){var value=node['value'];if(value.Id==me.hideNodeId){return true}for(var i in value){node[i]=value[i]}node['DataAddTime']=getMillisecondsFromStr(node['DataAddTime']);node['DataUpdateTime']=getMillisecondsFromStr(node['DataUpdateTime']);if(node['icon']&&node['icon']!=''){node['icon']=getIconRootPathBySize(16)+'/'+node['icon']}var children=node[me.childrenField];if(children){changeChildren(children)}return false};var changeChildren=function(children){for(var i=0;i<children.length;i++){var bo=changeNode(children[i]);if(bo){children.splice(i,1);i--}}};var children=data[me.childrenField];changeChildren(children);response.responseText=Ext.JSON.encode(data);return response},createTreeColumns:function(){var me=this;return me.columnsStr},ctreatetoolsBar:function(){var me=this;var filterBarArr=[];var tt='';var filtrationArr=[];var buttonBarArr=[];if(me.isFiltration==true){filtrationArr.push(me.createtoolsAddFilter())}if(me.isFunction==true){if(me.isreFreshBtn==true){filterBarArr.push(me.createtoolsreFreshBtn())}if(me.isPlusBtn==true){filterBarArr.push(me.createtoolsPlusBtn())}if(me.isMinusBtn==true){filterBarArr.push(me.createtoolsMinusBtn())}if(me.istoolsAddBtn==true){filterBarArr.push(me.createtoolsAddBtn())}if(me.istoolsShowBtn==true){filterBarArr.push(me.createtoolsShowBtn())}if(me.istoolsEditBtn==true){filterBarArr.push(me.createtoolsEditBtn())}if(me.istoolsDelBtn==true){filterBarArr.push(me.createtoolsDelBtn())}}if(me.isbuttonBar==true){if(me.isConfirmBtn==true){buttonBarArr.push(me.createisConfirmBtn)}if(me.isCancelBtn==true){buttonBarArr.push(me.createisCancelBtn())}}if(me.filterBar===me.functionBar&&me.filterBar===me.positionBar){var tempArr=filtrationArr.concat(buttonBarArr);tempArr=tempArr.concat(filterBarArr);tt=[{xtype:'toolbar',itemId:'treeToolbar',dock:me.filterBar,items:tempArr}]}else{var tempArrOne=[];var positionOne='';var tempArrTwo=[];var positionTwo='';if(me.filterBar===me.positionBar){tempArrOne=buttonBarArr.concat(filterBarArr);positionOne=me.filterBar;tempArrTwo=filtrationArr;positionTwo=me.functionBar}else if(me.filterBar===me.functionBar){tempArrOne=filterBarArr.concat(filtrationArr);positionOne=me.filterBar;tempArrTwo=buttonBarArr;positionTwo=me.positionBar}else if(me.functionBar===me.positionBar){tempArrOne=buttonBarArr.concat(filtrationArr);positionOne=me.functionBar;tempArrTwo=filterBarArr;positionTwo=me.filterBar}if(tempArrOne.length>0&&tempArrTwo.length>0){tt=[{xtype:'toolbar',itemId:'treeToolbar',dock:positionOne,items:tempArrOne},{xtype:'toolbar',itemId:'treeToolbarTwo',dock:positionTwo,items:tempArrTwo}]}else if(tempArrOne.length>0&&tempArrTwo.length==0){tt=[{xtype:'toolbar',itemId:'treeToolbar',dock:positionOne,items:tempArrOne}]}else if(tempArrOne.length==0&&tempArrTwo.length>0){tt=[{xtype:'toolbar',itemId:'treeToolbar',dock:positionTwo,items:tempArrTwo}]}else{tt=''}}if(me.isFiltration==false&&me.isFunction==false&&me.isbuttonBar==false){tt=''}return tt},createtoolsAddFilter:function(){var me=this;var filter={xtype:'textfield',fieldLabel:'',tooltip:'',itemId:'filterText',labelAlign:'right',labelWidth:6,enableKeyEvents:true,listeners:{keyup:{fn:function(field,e){var bo=Ext.EventObject.ESC==e.getKey();bo?field.onTriggerClick():me.filterByText(this.getRawValue())}}}};return filter},filterByText:function(text){this.filterBy(text,'text')},filterBy:function(text,by){this.clearFilter();var view=this.getView(),me=this,nodesAndParents=[];this.getRootNode().cascadeBy(function(tree,view){var currNode=this;if(currNode&&currNode.data[by]){if(currNode.data[by].toString().toLowerCase().indexOf(text.toLowerCase())>-1){me.expandPath(currNode.getPath());while(currNode.parentNode){nodesAndParents.push(currNode.id);currNode=currNode.parentNode}}}},null,[me,view]);this.getRootNode().cascadeBy(function(tree,view){var uiNode=view.getNodeByRecord(this);if(uiNode&&!Ext.Array.contains(nodesAndParents,this.id)){Ext.get(uiNode).setDisplayed('none')}},null,[me,view])},clearFilter:function(){var view=this.getView();this.getRootNode().cascadeBy(function(tree,view){var uiNode=view.getNodeByRecord(this);if(uiNode){Ext.get(uiNode).setDisplayed('table-row')}},null,[this,view])},createtoolsreFreshBtn:function(){var me=this;var refreshBtn={iconCls:'build-button-refresh',type:'refresh',itemId:'refresh',tooltip:'刷新数据',text:'',handler:function(event,toolEl,owner,tool){var treeToolbar=me.getComponent('treeToolbar');if(treeToolbar==undefined||treeToolbar==''){treeToolbar=me.getComponent('treeToolbarTwo')}if(treeToolbar&&treeToolbar!=undefined){var refresh=treeToolbar.getComponent('refresh');if(refresh&&refresh!=undefined){refresh.disabled=true}}me.load('')}};return refreshBtn},createtoolsPlusBtn:function(){var me=this;var plusBtn={text:'',iconCls:'build-button-arrow-in',type:'minus',itemId:'minus',tooltip:'全部收缩',handler:function(event,toolEl,owner,tool){me.collapseAll();me.getRootNode().expand()}};return plusBtn},createtoolsMinusBtn:function(){var me=this;var minusBtn={iconCls:'build-button-arrow-out',type:'plus',itemId:'plus',tooltip:'全部展开',text:'',handler:function(event,toolEl,owner,tool){me.expandAll()}};return minusBtn},initComponent:function(){var me=this;me.columns=me.createTreeColumns();me.addEvents('okClick');me.addEvents('cancelClick');me.dockedItems=me.ctreatetoolsBar();me.store=me.createStore();me.load=function(whereStr){var w='?fields='+me.whereFields;var myUrl=me.selectServerUrl+w;me.store.proxy.url=myUrl;me.store.load()};me.listeners=me.listeners||[];me.listeners.checkchange=function(node,checked){if(me.linkageType==false){if(checked){node.expand();node.eachChild(function(child){child.data.checked=true;child.updateInfo({checked:true});if(child.data.leaf==false){me.setNode(child)}me.chd(child,true)})}else{node.expand();node.eachChild(function(child){child.data.checked=false;child.updateInfo({checked:false});if(child.data.leaf==false){me.setNodefalse(child)}me.chd(child,false)})}me.parentnode(node)}else{if(node.data.leaf==false){if(checked){node.expand();node.eachChild(function(n){n.data.checked=true;n.updateInfo({checked:true});if(n.data.leaf==false){me.setNode(n)}})}else{node.expand();node.eachChild(function(n){n.data.checked=false;n.updateInfo({checked:false});if(n.data.leaf==false){me.setNodefalse(n)}})}}else{if(checked){me.setParentnode(node)}else{var parentNode=node.parentNode;var checked=false;parentNode.eachChild(function(n){if(n.data.checked){checked=n.data.checked}});node.parentNode.data.checked=checked;node.parentNode.updateInfo({checked:checked})}}}};this.callParent(arguments)},setTreeChecked:function(arrParamsValue){var me=this;var rootNode=me.getRootNode();me.setNodefalse(rootNode);var expandParentNode=function(value,callback){var arr=value.split("_");if(arr.length>1){var v=arr[0];var num=1;var open=function(){if(num<arr.length-1){v=v+"_"+arr[num];var n=rootNode.findChild("Id",v,true);if(!n.isExpanded()){num++;n.expand(false,open)}else{num++;open()}}else{callback()}};open()}else{callback()}};var checkedNode=function(value){var node=rootNode.findChild("Id",value,true);if(node!=null){node.set('checked',true)}};var nodeArr=[];for(var i in arrParamsValue){var value=arrParamsValue[i].moduleId;var node=rootNode.findChild("Id",value,true);if(node!=null){node.set('checked',true)}else{nodeArr.push(value)}}var openNodes=function(nodes){for(var i in nodes){checkedNode(nodes[i])}};if(nodeArr.length==0){me.isJustOpen=false}else{var count=0;var changeNodes=function(num){var callback=function(){if(num==nodeArr.length-1){if(me.appId!=-1&&me.isJustOpen){openNodes(nodeArr);me.isJustOpen=false}}else{changeNodes(++num)}};expandParentNode(nodeArr[num],callback)};setTimeout(function(){changeNodes(0)},500)}},getAllChecked:function(){var me=this;var arrChecked=[];arrChecked=me.getChecked();return arrChecked},getAllChanged:function(){var me=this;var allChangedValue=[];me.store.each(function(record){allChangedValue.push(record)});return allChangedValue}});