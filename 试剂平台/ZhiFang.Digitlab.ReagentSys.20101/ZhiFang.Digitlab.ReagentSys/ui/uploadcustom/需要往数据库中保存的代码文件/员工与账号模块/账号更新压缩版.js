Ext.ns('Ext.zhifangux'),Ext.define('Ext.zhifangux.UpdateAccount',{extend:'Ext.form.Panel',alias:'widget.updateaccount',title:'账号更新',isClose:!1,width:330,height:220,CheckUserNameUrl:getRootPath()+'/'+'RBACService.svc/RBAC_RJ_ValidateUserAccountIsExist',userTpe:'present',userInfo:'',header:!0,objectName:'RBACUser',isSuccessMsg:!0,getAppInfoServerUrl:getRootPath()+'/'+'ConstructionService.svc/CS_UDTO_SearchBTDAppComponentsById',addDataServerUrl:'RBACService.svc/RBAC_UDTO_AddRBACUser',editDataServerUrl:'RBACService.svc/RBAC_UDTO_UpdateRBACUserByField',classCode:'BTDAppComponents_ClassCode',PresentUrl:getRootPath()+'/'+'RBACService.svc/RBAC_UDTO_GetHREmployeeBySessionHREmpID',autoScroll:!0,type:'add',bodyCls:'',layout:'absolute',setWinformInfo:function(e,t){var n=this,r=t.boundField,i=e.get('Id'),s=e.get('text'),o=n.getComponent(r);o.treeNodeID=e.get('Id');if(o.xtype=='combobox'){var u=[[i,s]];o.store=new Ext.data.SimpleStore({fields:['value','text'],data:u,autoLoad:!0}),o.setValue(i)}else o.treeNodeID=i,o.setValue(s)},getInfoByIdFormServer:function(e,t){var n=this,r=n.getAppInfoServerUrl+'?isPlanish=true&id='+e;Ext.Ajax.defaultPostHeader='application/json',Ext.Ajax.request({async:!1,url:r,method:'GET',timeout:2e3,success:function(e,n){var r=Ext.JSON.decode(e.responseText);if(r.success){var i='';r.ResultDataValue&&r.ResultDataValue!=''&&(r.ResultDataValue=r.ResultDataValue.replace(/\\n/g,'\\\\u000a'),i=Ext.JSON.decode(r.ResultDataValue)),Ext.typeOf(t)=='function'&&(i==''?alertError('没有获取到应用组件信息！'):t(i))}else alertError('获取应用信息失败！')},failure:function(e,t){alertError('获取应用信息请求失败！')}})},functionBtnClick:function(e,t,n){var r=this,i=e.boundField,s=r.getComponent(i),o=s.appComID;if(o!=''&&o!=null&&o!=undefined){var u=function(t){var n=s.getValue(),i='';t&&t!=''&&(i=t[r.classCode]),i&&i!=''?r.openAppShowWin(n,i,e):alertError('没有类代码！')};r.getInfoByIdFormServer(o,u)}else alertError('功能按钮没有绑定应用！')},openAppShowWin:function(title,classCode,com){var me=this,panel=eval(classCode),maxHeight=document.body.clientHeight*.98,maxWidth=document.body.clientWidth*.98,appList=Ext.create(panel,{maxWidth:maxWidth,maxHeight:maxHeight,autoScroll:!0,model:!0,floating:!0,closable:!0,draggable:!0}).show();appList.on({okClick:function(){var e=appList.getValue();e.length==0?alertError('请选择一个应用！'):e.length==1&&me.setWinformInfo(e[0],com)},itemdblclick:function(e,t,n,r,i,s){me.setWinformInfo(t,com)}})},GetGroupItems:function(e,t,n,r,i){var s=e;if(s==''||s==null)return alertError(s),null;s=getRootPath()+'/'+s;var o=[];return Ext.Ajax.request({async:!1,timeout:6e3,url:s,method:'GET',success:function(e,s){var u=Ext.JSON.decode(e.responseText);if(u.success){var a={count:0,list:[]};u.ResultDataValue&&u['ResultDataValue']!=''&&(a=Ext.JSON.decode(u.ResultDataValue));var f=a.count,l=!1,c=[];i!=''&&(c=i.split(','));for(var h=0;h<f;h++){var p=a.list[h][t],d=a.list[h][n];c.length>0&&(l=Ext.Array.contains(c,p));var v={checked:l,name:r,boxLabel:d,inputValue:p};o.push(v)}}else alertError('获取信息失败！')}}),o},beforeRender:function(){var e=this;e.callParent(arguments),e.header!==!1&&e.updateHeader()},initComponent:function(){var e=this;e.OverrideField(),e.LenTypes(),e.addEvents('beforeSave'),e.addEvents('saveClick'),e.addEvents('functionBtnClick'),e.load=function(t){Ext.Ajax.request({async:!1,url:getRootPath()+'/RBACService.svc/RBAC_UDTO_SearchRBACUserById?isPlanish=true&fields=RBACUser_Account,RBACUser_EnMPwd,RBACUser_AccBeginTime,RBACUser_AccEndTime,RBACUser_Id&id='+(t?t:-1),method:'GET',timeout:5e3,success:function(t,n){var r=Ext.JSON.decode(t.responseText);if(r.success){if(r.ResultDataValue&&r.ResultDataValue!=''){e.type=='add'&&(e.type='edit');var i=Ext.JSON.decode(r.ResultDataValue);e.getForm().setValues(i)}}else alertError('获取表单数据失败！')},failure:function(e,t){alertError('获取表单数据请求失败！')}})},e.setValueByItemId=function(t,n){e.getForm().setValues([{id:t,value:n}])},e.changeStoreData=function(e){var t=Ext.JSON.decode(e.responseText);if(t.ResultDataValue&&t.ResultDataValue!=''){var n=Ext.JSON.decode(t.ResultDataValue);t.ResultDataValue=n,t.list=n.list}else t.list=[];return e.responseText=Ext.JSON.encode(t),e},e.setReadOnly=function(t){var n=e.items.items;for(var r in n)if(!n[r].hasReadOnly){var i=n[r].xtype;i!='button'&&i!='label'&&i!='box'&&n[r].setReadOnly(t)}},e.items=[{xtype:'textfield',name:'RBACUser_Account',fieldLabel:'员工账号',labelWidth:80,labelStyle:'font-style:normal;',width:215,height:22,itemId:'RBACUser_Account',x:10,y:5,readOnly:!1,appComID:'',treeNodeID:'',value:'',isFunctionBtn:!1,allowBlank:!1,emptyText:'3-12位不能重复的账号',blankText:'请输入员工账号',maxLengthText:'长度不能超过12个字符',minLengthText:'长度不能超过3个字符',hidden:!1,sortNum:1,showValidIcon:!1,msgTarget:'side',vtype:'isLen',validateOnBlur:!0,validateOnChange:!0,listeners:{scope:this,specialkey:function(e,t){var n=1,r='sortNum',i=e.ownerCt,s=e[r],o=i.items.items,u=5;(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)&&t.preventDefault();if(s>0&&(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)){t.shiftKey?s=s-n<1?s-n+u:s-n:s=s+n>u?s+n-u:s+n;for(var a in o)if(o[a].sortNum==s){o[a].focus(!1,100);break}}},blur:function(t,n){var r=e.getComponent('RBACUser_Account'),i=e.getComponent('txtAccount'),s=r.getValue(),o=e.getComponent('RBACUser_Id').getValue(),u=e.getComponent('txtBJ'),a=e.getComponent('txtBJCD'),f=e.getComponent('yzimage'),l=function(e){var t=e;t.result=='true'&&(s.length>=3&&s.length<=12?(u.setVisible(!0),a.setVisible(!1),f.getEl().dom.src=''):(u.setVisible(!1),a.setVisible(!0),f.getEl().dom.src='')),t.result=='false'&&(s.length>=3&&s.length<=12?(u.setVisible(!1),a.setVisible(!1),f.getEl().dom.src=getIconRootPathBySize(64)+'/'+'accept.png'):(u.setVisible(!1),a.setVisible(!0),f.getEl().dom.src=''))};i.getValue()!=r.getValue()?e.validator(s,l):(f.getEl().dom.src='',u.setVisible(!1))}},hasReadOnly:!1,labelAlign:'left'},{xtype:'label',cls:'textfield-red',style:'color:red;background:white;',labelStyle:'font-style:normal;',width:82,height:22,itemId:'txtBJ',hidden:!0,x:218,y:5,text:'账号已存在'},{xtype:'label',cls:'textfield-red',style:'color:red;background:white;',labelStyle:'font-style:normal;',width:82,height:22,itemId:'txtBJCD',hidden:!0,x:218,y:5,text:'账号长度不符'},{xtype:'box',width:26,id:'yzimage',itemId:'yzimage',x:220,y:3,height:26,autoEl:{tag:'img',src:''}},{xtype:'checkboxfield',name:'RBACUser_EnMPwd',labelWidth:80,labelStyle:'font-style:normal;',boxLabel:'允许修改密码',fieldLabel:' ',labelSeparator:'',width:220,height:22,itemId:'RBACUser_EnMPwd',x:5,y:95,readOnly:!1,appComID:'',treeNodeID:'',value:'',isFunctionBtn:!1,hidden:!1,sortNum:2,listeners:{scope:this,specialkey:function(e,t){var n=1,r='sortNum',i=e.ownerCt,s=e[r],o=i.items.items,u=5;(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)&&t.preventDefault();if(s>0&&(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)){t.shiftKey?s=s-n<1?s-n+u:s-n:s=s+n>u?s+n-u:s+n;for(var a in o)if(o[a].sortNum==s){o[a].focus(!1,100);break}}}},hasReadOnly:!1,labelAlign:'left'},{xtype:'textfield',name:'txtAccount',hidden:!0,fieldLabel:'old员工账号',labelWidth:80,labelStyle:'font-style:normal;',width:220,height:22,itemId:'txtAccount',x:2,y:125,readOnly:!0},{xtype:'datefield',name:'RBACUser_AccBeginTime',fieldLabel:'账号开始日期',labelWidth:80,labelStyle:'font-style:normal;',width:215,height:22,editable:!0,itemId:'RBACUser_AccBeginTime',x:10,y:35,readOnly:!1,hidden:!1,format:'Y-m-d',sortNum:3,msgTarget:'side',listeners:{scope:this,specialkey:function(e,t){var n=1,r='sortNum',i=e.ownerCt,s=e[r],o=i.items.items,u=5;(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)&&t.preventDefault();if(s>0&&(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)){t.shiftKey?s=s-n<1?s-n+u:s-n:s=s+n>u?s+n-u:s+n;for(var a in o)if(o[a].sortNum==s){o[a].focus(!1,100);break}}}},hasReadOnly:!1,labelAlign:'left'},{xtype:'datefield',name:'RBACUser_AccEndTime',fieldLabel:'账号截止日期',labelWidth:80,labelStyle:'font-style:normal;',width:215,height:22,editable:!0,itemId:'RBACUser_AccEndTime',x:10,y:65,readOnly:!1,hidden:!1,format:'Y-m-d',sortNum:4,msgTarget:'side',listeners:{scope:this,specialkey:function(e,t){var n=1,r='sortNum',i=e.ownerCt,s=e[r],o=i.items.items,u=5;(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)&&t.preventDefault();if(s>0&&(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)){t.shiftKey?s=s-n<1?s-n+u:s-n:s=s+n>u?s+n-u:s+n;for(var a in o)if(o[a].sortNum==s){o[a].focus(!1,100);break}}}},hasReadOnly:!1,labelAlign:'left'},{xtype:'textfield',name:'RBACUser_HREmployee_Id',fieldLabel:'主键ID',labelWidth:60,labelStyle:'font-style:normal;',width:160,height:22,itemId:'RBACUser_HREmployee_Id',x:5,y:135,readOnly:!1,appComID:'',treeNodeID:'',value:'',isFunctionBtn:!1,hidden:!0,sortNum:6,listeners:{scope:this,specialkey:function(e,t){var n=1,r='sortNum',i=e.ownerCt,s=e[r],o=i.items.items,u=9;(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)&&t.preventDefault();if(s>0&&(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)){t.shiftKey?s=s-n<1?s-n+u:s-n:s=s+n>u?s+n-u:s+n;for(var a in o)if(o[a].sortNum==s){o[a].focus(!1,100);break}}}},hasReadOnly:!1,labelAlign:'left'},{xtype:'textfield',name:'RBACUser_HREmployee_DataTimeStamp',fieldLabel:'时间戳',labelWidth:60,labelStyle:'font-style:normal;',width:160,height:22,itemId:'RBACUser_HREmployee_DataTimeStamp',x:5,y:161,readOnly:!1,appComID:'',treeNodeID:'',value:'',isFunctionBtn:!1,hidden:!0,sortNum:7,listeners:{scope:this,specialkey:function(e,t){var n=1,r='sortNum',i=e.ownerCt,s=e[r],o=i.items.items,u=9;(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)&&t.preventDefault();if(s>0&&(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)){t.shiftKey?s=s-n<1?s-n+u:s-n:s=s+n>u?s+n-u:s+n;for(var a in o)if(o[a].sortNum==s){o[a].focus(!1,100);break}}}},hasReadOnly:!1,labelAlign:'left'},{xtype:'textfield',name:'RBACUser_Id',fieldLabel:'主键ID',labelWidth:60,labelStyle:'font-style:normal;',width:160,height:22,itemId:'RBACUser_Id',x:5,y:187,readOnly:!1,appComID:'',treeNodeID:'',value:'',isFunctionBtn:!1,hidden:!0,sortNum:8,listeners:{scope:this,specialkey:function(e,t){var n=1,r='sortNum',i=e.ownerCt,s=e[r],o=i.items.items,u=9;(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)&&t.preventDefault();if(s>0&&(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)){t.shiftKey?s=s-n<1?s-n+u:s-n:s=s+n>u?s+n-u:s+n;for(var a in o)if(o[a].sortNum==s){o[a].focus(!1,100);break}}}},hasReadOnly:!1,labelAlign:'left'},{xtype:'textfield',name:'RBACUser_DataTimeStamp',fieldLabel:'时间戳',labelWidth:60,labelStyle:'font-style:normal;',width:160,height:22,itemId:'RBACUser_DataTimeStamp',x:5,y:213,readOnly:!1,appComID:'',treeNodeID:'',value:'',isFunctionBtn:!1,hidden:!0,sortNum:9,listeners:{scope:this,specialkey:function(e,t){var n=1,r='sortNum',i=e.ownerCt,s=e[r],o=i.items.items,u=9;(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)&&t.preventDefault();if(s>0&&(t.getKey()==Ext.EventObject.ENTER||t.getKey()==Ext.EventObject.TAB)){t.shiftKey?s=s-n<1?s-n+u:s-n:s=s+n>u?s+n-u:s+n;for(var a in o)if(o[a].sortNum==s){o[a].focus(!1,100);break}}}},hasReadOnly:!1,labelAlign:'left'}],e.type=='show'?e.height-=25:e.dockedItems=[{xtype:'toolbar',dock:'bottom',itemId:'buttons',items:['->',{xtype:'button',text:'保存',iconCls:'button-save',handler:function(){var t=e.getComponent('RBACUser_Account').getValue(),n=e.getComponent('RBACUser_EnMPwd').getValue(),r=e.getComponent('RBACUser_AccBeginTime').getValue(),i=''+Ext.util.Format.date(r,'Y-m-d'),s=convertJSONDateToJSDateObject(i),o=e.getComponent('RBACUser_AccEndTime').getValue(),u=''+Ext.util.Format.date(o,'Y-m-d'),a=convertJSONDateToJSDateObject(u),f=e.getComponent('RBACUser_Id').getValue(),l={RBACUser_Id:f,RBACUser_Account:t,RBACUser_EnMPwd:n,RBACUser_AccBeginTime:s,RBACUser_AccEndTime:a};e.updateUser(l)}},{xtype:'button',text:'重置',iconCls:'build-button-refresh',handler:function(){e.getForm().reset()}}]}],e.callParent(arguments)},afterRender:function(){var e=this;e.callParent(arguments),Ext.typeOf(e.callback)=='function'&&e.callback(e),e.userTpe=='present'?e.getServer():e.userTpe=='amdin'&&e.load()},getServer:function(){var e=this;Ext.Ajax.defaultPostHeader='application/json',Ext.Ajax.request({async:!1,url:e.PresentUrl,method:'GET',success:function(t){var n=Ext.JSON.decode(t.responseText);if(n.success&&n.ResultDataValue&&n.ResultDataValue!=''){var r=Ext.JSON.decode(n.ResultDataValue);if(r.RBACUserList&&r.RBACUserList!=''&&r.RBACUserList!=undefined)var i=r.RBACUserList[0].Account,s=r.RBACUserList[0].PWD,o=r.RBACUserList[0].EnMPwd,u=r.RBACUserList[0].AccBeginTime,a=r.RBACUserList[0].AccEndTime,f=r.RBACUserList[0].DataTimeStamp,l=r.RBACUserList[0].Id;else var i='',s='',o='',u='',a='',f='',l='';var c=e.getComponent('RBACUser_Account'),h=e.getComponent('RBACUser_EnMPwd'),p=e.getComponent('RBACUser_AccBeginTime'),d=e.getComponent('RBACUser_AccEndTime'),v=e.getComponent('RBACUser_Id');c.setValue(i),h.setValue(s),p.setValue(u),d.setValue(a),v.setValue(l)}},failure:function(e,t){alertError('获取信息请求失败！')}})},validator:function(e,t){var n=this,r=this,i=!0;return Ext.Ajax.request({async:!1,scope:r,url:n.CheckUserNameUrl+'?strUserAccount='+e,method:'GET',success:function(e){var n=Ext.JSON.decode(e.responseText);if(n.success)if(n.ResultDataValue&&n.ResultDataValue!=''){var r=Ext.JSON.decode(n.ResultDataValue);Ext.typeOf(t)=='function'&&t(r)}else alertError('没有获取到应用信息！');else alertError('获取应用信息失败！错误信息:'+n.ErrorInfo)},failure:function(e,t){alertError('获取信息请求失败！')}}),i},updateUser:function(strobj){var me=this,myUrl='';me.editDataServerUrl!=''&&(myUrl=getRootPath()+'/'+me.editDataServerUrl);var values=strobj,maxLength=0;for(var i in values){var arr=i.split('_');arr.length>maxLength&&(maxLength=arr.length)}var obj={},addObj=function(key,num,value){var keyArr=key.split('_'),ob='obj',objSJC='';for(var i=1;i<keyArr.length;i++)ob=ob+'["'+keyArr[i]+'"]',objSJC=keyArr[i],eval(ob)||eval(ob+'={};');keyArr.length==num+1&&(objSJC=='DataTimeStamp'&&(value=value.split(',')),eval(ob+'=value;'))};for(var i=1;i<maxLength;i++)for(var j in values){var value=values[j];addObj(j,i,value)}var field='';if(maxLength==2)for(var i in values){var keyArr=i.split('_');field=field+keyArr[1]+','}field!=''&&(field=field.substring(0,field.length-1)),Ext.Ajax.defaultPostHeader='application/json',Ext.Ajax.request({async:!1,url:myUrl,params:Ext.JSON.encode({entity:obj,fields:field}),method:'POST',timeout:7e3,success:function(e,t){var n=Ext.JSON.decode(e.responseText);me.fireEvent('saveClick'),n.success?alertError('保存成功！'):alertError('保存应用组件失败！错误信息:'+n.ErrorInfo)},failure:function(e,t){alertError('保存应用组件请求失败！')}})},OverrideField:function(){var e=Ext.layout.component.field.Field.override({getErrorStrategy:function(){var e=this,t=e.owner,n=e.errorStrategies,r=t.msgTarget,i=!t.preventMark&&Ext.isString(r)?n[r]||n.elementId:n.none;return r=='side'&&t.showValidIcon&&(t.isIconInit&&(t.errorEl.setDisplayed(!1),t.isIconInit=!0),t.on('validitychange',function(e,t){e.errorEl.setDisplayed(!0)}),Ext.apply(i,{adjustHorizInsets:Ext.emptyFn,layoutHoriz:function(e,t,n){e.errorContext.setProp('x',n.width)},layoutVert:function(e,t){e.errorContext.setProp('y',e.insets.top)},prepare:function(e,t){var n=t.errorEl;n.addCls(Ext.baseCSSPrefix+'form-invalid-icon'),n.set({'data-errorqtip':t.getActiveError()||''});var r=t.getActiveError(),i=!!r;n[i?'removeCls':'addCls']('icon-yes'),Ext.layout.component.field.Field.initTip()}})),i}});return e},LenTypes:function(){var e=Ext.apply(Ext.form.VTypes,{isLen:function(e,t){var n=/^[a-zA-Z0-9_]{3,13}$/,r=e.match(n);return r==null?!1:!0},isLenText:'3-12位不能重复的账号'});return e}})