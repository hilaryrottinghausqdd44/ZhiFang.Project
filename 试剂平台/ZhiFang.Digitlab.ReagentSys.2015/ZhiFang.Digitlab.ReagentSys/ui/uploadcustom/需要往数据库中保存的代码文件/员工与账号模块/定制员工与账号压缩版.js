Ext.define('yuangongyuzhanghao',{extend:'Ext.panel.Panel',panelType:'Ext.panel.Panel',alias:'widget.yuangongyuzhanghao',title:'员工与账号',width:875,height:382,layout:{type:'border',regionWeights:{east:1}},fields:'RBACUser_Id,RBACUser_UseCode,RBACUser_Account,RBACUser_PWD,RBACUser_EnMPwd,RBACUser_PwdExprd,RBACUser_HREmployee_Id,RBACUser_HREmployee_DataTimeStamp,RBACUser_AccExprd,RBACUser_AccLock,RBACUser_AuUnlock,RBACUser_LoginTime,RBACUser_AccBeginTime,RBACUser_AccEndTime',getAppInfoServerUrl:getRootPath()+'/ConstructionService.svc/CS_UDTO_SearchBTDAppComponentsById',resetPasswordUrl:getRootPath()+'/RBACService.svc/RBAC_RJ_ResetAccountPassword',editDataServerUrl:'RBACService.svc/RBAC_UDTO_UpdateRBACUserByField',appInfos:[{width:460,appId:'5553644655354790415',header:!1,itemId:'yuangongyuzhanghuTab',title:'员工账户',region:'east',split:!0,collapsible:!0,collapsed:!1,border:!0},{appId:'4891921432055379413',header:!1,itemId:'yuangongListTab',title:'员工列表',region:'center',border:!0}],comNum:0,afterRender:function(){var e=this;e.callParent(arguments),e.create()},create:function(){var e=this,t=e.getAppInfos();for(var n in t){var r=t[n].appId,i=e.getCallback(t[n]);e.getAppInfoFromServer(r,i)}},getCallback:function(appInfo){var me=this,callback=function(obj){if(obj.success&&obj.appInfo!=''){var ModuleOperCode=obj.appInfo.BTDAppComponents_ModuleOperCode,ClassCode=obj.appInfo.BTDAppComponents_ClassCode,cl=eval(ClassCode),callback2=function(e){me.initLink(e)};appInfo.callback=callback2;var panel=Ext.create(cl,appInfo);me.add(panel),me.panelType=='Ext.tab.Panel'&&(appInfo.defaultactive&&(me.defaultactive=appInfo.itemId),me.setActiveTab(panel))}else{appInfo.html=obj.ErrorInfo;var panel=Ext.create('Ext.panel.Panel',appInfo);me.add(panel),me.panelType=='Ext.tab.Panel'&&(appInfo.defaultactive&&(me.defaultactive=appInfo.itemId),me.setActiveTab(panel))}};return callback},getAppInfos:function(){var e=this,t=e.appInfos;for(var n in t)t[n].title==''?delete t[n].title:t[n].title=='_'&&(t[n].title='');return Ext.clone(t)},initLink:function(e){var t=this,n=t.getAppInfos(),r=n.length;t.comNum++;if(t.comNum==r){if(t.panelType=='Ext.tab.Panel'){var i=function(){t.setActiveTab(t.defaultactive),t.un('tabchange',i)};t.on('tabchange',i)}var s='',o='',u='',a=t.getComponent('yuangongListTab').getComponent('yuangongListRead'),f=t.getComponent('yuangongyuzhanghuTab').getComponent('zhanghaoxianshiForm'),l=t.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm'),c=l.getComponent('HREmployee_NameL'),h=l.getComponent('HREmployee_NameF'),p=l.getComponent('HREmployee_CName');c&&c!=undefined&&c.on({change:function(e,n,r,i){if(l.isLoadingComplete==1&&(l.type=='edit'||l.type=='add')){var s=h.getValue();s!=null&&s!=''?(t.setPinYinZiTouValue(n+s),p.setValue(n+s)):(t.setPinYinZiTouValue(n),p.setValue(n))}}}),h&&h!=undefined&&h.on({change:function(e,n,r,i){if(l.isLoadingComplete==1&&(l.type=='edit'||l.type=='add')){var s=c.getValue();s!=null&&s!=''?(t.setPinYinZiTouValue(s+n),p.setValue(s+n)):(t.setPinYinZiTouValue(n),p.setValue(n))}}}),l.on({saveClick:function(){var e=l.getForm().getValues(),t=l.objectName+'_Id',n=e[t];n!=''&&(a.autoSelect=n,a.load(!0))},beforeSave:function(){var e=l.getComponent('HREmployee_NameL'),t=l.getComponent('HREmployee_NameF');if(e){var n=e.getValue();if(n==null||n==''||n==undefined)return alertError('员工姓不能为空！'),!1}if(t){var r=t.getValue();if(r==null||r==''||r==undefined)return alertError('员工名字不能为空！'),!1}}}),a.store.on({load:function(e,n){var r=n;if(e.data.length==0){var i=t.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm'),s=t.getComponent('yuangongyuzhanghuTab').getComponent('zhanghaoxianshiForm');i.getForm().reset(),s.getForm().reset();var o=t.getComponent('yuangongyuzhanghuTab').getComponent('zhanghaoxianshiForm'),u=o.getComponent('btnAdd'),a=o.getComponent('btnUse'),f=o.getComponent('btnUpdate'),l=o.getComponent('btnPassWord');u.disable(!0),a.disable(!0),f.disable(!0),l.disable(!0)}}}),a.on({select:function(e,n){var r=n.get(a.objectName+'_Id');t.listRecord=n[0];var i=t.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm');n!=null&&(Id=n.get(a.objectName+'_Id'),i.load(r),t.setDaptValue(n));var o=t.getComponent('yuangongyuzhanghuTab').getComponent('zhanghaoxianshiForm'),u=getRootPath()+'/RBACService.svc/RBAC_UDTO_SearchRBACUserListByHQL?&isPlanish=true'+'&fields='+t.fields+'&where='+'rbacuser.HREmployee.Id='+r,f=function(e){if(e&&e!=''){var n=e;s=e;var r=o.getComponent('RBACUser_Account'),i=o.getComponent('RBACUser_AccBeginTime'),u=o.getComponent('RBACUser_AccEndTime'),a=o.getComponent('RBACUser_EnMPwd'),f=o.getComponent('RBACUser_AccLock');r.setValue(n.RBACUser_Account),i.setValue(n.RBACUser_AccBeginTime),u.setValue(n.RBACUser_AccEndTime),a.setValue(n.RBACUser_EnMPwd),f.setValue(n.RBACUser_AccLock),a.setReadOnly(!0),f.setReadOnly(!0);var l=t.getComponent('yuangongyuzhanghuTab').getComponent('zhanghaoxianshiForm'),c=l.getComponent('btnAdd'),h=l.getComponent('btnUse'),p=l.getComponent('btnUpdate'),d=l.getComponent('btnPassWord');n['RBACUser_Account']!=''?(c.disable(!0),h.enable(!0),p.enable(!0),d.enable(!0),n['RBACUser_AccLock']=='true'?h.setText('账号启用'):h.setText('账号停用')):(c.enable(!0),h.disable(!0),p.disable(!0),d.disable(!0))}};t.getAccountInfo(u,f)},addClick:function(e){var n=t.getComponent('yuangongyuzhanghuTab');n.setActiveTab('yuangongxxForm');var r=t.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm');r.isAdd(),r.isLoadingComplete=!0;var i=null;t.doAddClick()},editClick:function(e){var n=t.getComponent('yuangongyuzhanghuTab');n.setActiveTab('yuangongxxForm');var r=a,i=r.getSelectionModel().getSelection();if(i.length==1){var s=i[0],o=s.get(a.objectName+'_Id'),u=t.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm');u.isEdit(o),u.isLoadingComplete=!0,t.setDaptValue(s)}else alertInfo('请选择一条数据进行操作！')},saveClick:function(e){var n=t.getComponent('yuangongListTab').getComponent('yuangongListRead')}});var d=t.getComponent('yuangongListTab').getComponent('bumenTreeQuery');d.on({load:function(e,n,r,i,s){t.bmTreeLoadStore=!0},select:function(e,t){var n=d.getSelectionModel().getSelection(),t=null;n&&n.length>0?(t=n[0],o=n[0]):t=null}}),f.on({AfterOpenWinbtnUpdate:function(e){var t=s.RBACUser_Id,n=s.RBACUser_HREmployee_Id,r=e.getComponent('RBACUser_HREmployee_Id'),i=e.getComponent('RBACUser_Account'),o=e.getComponent('RBACUser_AccBeginTime'),u=e.getComponent('RBACUser_AccEndTime');r.setValue(n);var l=Ext.Date.format(new Date(s.RBACUser_AccBeginTime),'Y-m-d'),c=Ext.Date.format(new Date(s.RBACUser_AccEndTime),'Y-m-d');e.load(t);var h=f.getForm().getValues(),p=e.getComponent('txtAccount'),d=h.RBACUser_Account;p.setValue(d);if(s['RBACUser_AccBeginTime']!='')o.setValue(l);else{var v=Ext.Date.format(new Date,'Y-m-d');o.setValue(v)}u.setValue(c),e.on({saveClick:function(){e.close();var t=e.getForm().getValues(),n='RBACUser_HREmployee_Id',r=t[n];r!=''&&(a.autoSelect=r,a.load(!0))}})},AfterOpenWinbtnAdd:function(e){var n=t.getComponent('yuangongListTab').getComponent('yuangongListRead'),r=n.getSelectionModel().getSelection(),i=r[0],s=e,o=s.getComponent('RBACUser_HREmployee_Id'),u=s.getComponent('RBACUser_HREmployee_DataTimeStamp');if(i&&i!=''&&i!=undefined){var f=i.data[a.objectName+'_Id'],l=i.data.HREmployee_DataTimeStamp;o.setValue(f),u.setValue(l)}e.on({saveClick:function(){e.close();var t=e.getForm().getValues(),n='RBACUser_HREmployee_Id',r=t[n];r!=''&&(a.autoSelect=r,a.load(!0))}})}});var v=t.getComponent('yuangongyuzhanghuTab').getComponent('zhanghaoxianshiForm'),m=v.getComponent('btnAdd'),g=v.getComponent('btnUse'),y=v.getComponent('btnUpdate'),b=v.getComponent('btnPassWord'),w=v.getComponent('RBACUser_AccLock');g.on({click:function(e,n,r){var i='';e.getText()=='账号停用'?(e.setText('账号启用'),i=!0,w.setValue(!0)):(e.setText('账号停用'),i=!1,w.setValue(!1));var o={RBACUser_Id:s.RBACUser_Id,RBACUser_AccLock:i};t.updateUserInfo(o,t.editDataServerUrl,0)}}),b.on({click:function(e,n,r){var i=s,o=i.RBACUser_Id;o&&o!=''&&o!=undefined&&t.resetPassword(o)}}),Ext.typeOf(t.callback)=='function'&&t.callback(t)}},getAccountInfo:function(e,t){var n=this;Ext.Ajax.defaultPostHeader='application/json',Ext.Ajax.request({async:!1,url:e,method:'GET',timeout:2e3,success:function(e,n){var r=Ext.JSON.decode(e.responseText);if(r.success){if(r.ResultDataValue&&r.ResultDataValue!=''){var i=Ext.JSON.decode(r.ResultDataValue);if(i.list&&i.list!=''&&i.list!=undefined)var s={RBACUser_Account:i.list[0].RBACUser_Account,RBACUser_PWD:i.list[0].RBACUser_PWD,RBACUser_EnMPwd:i.list[0].RBACUser_EnMPwd,RBACUser_AccBeginTime:i.list[0].RBACUser_AccBeginTime,RBACUser_AccEndTime:i.list[0].RBACUser_AccEndTime,RBACUser_Id:i.list[0].RBACUser_Id,RBACUser_HREmployee_Id:i.list[0].RBACUser_HREmployee_Id,RBACUser_HREmployee_DataTimeStamp:i.list[0].RBACUser_HREmployee_DataTimeStamp,RBACUser_DataTimeStamp:i.list[0].RBACUser_DataTimeStamp,RBACUser_AccLock:i.list[0].RBACUser_AccLock,RBACUser_AuUnlock:i.list[0].RBACUser_AuUnlock};else var s={RBACUser_Account:'',RBACUser_PWD:'',RBACUser_EnMPwd:'',RBACUser_AccBeginTime:'',RBACUser_AccEndTime:'',RBACUser_Id:'',RBACUser_HREmployee_Id:'',RBACUser_HREmployee_DataTimeStamp:'',RBACUser_DataTimeStamp:'',RBACUser_AccLock:'',RBACUser_AuUnlock:''}}else var s={RBACUser_Account:'',RBACUser_PWD:'',RBACUser_EnMPwd:'',RBACUser_AccBeginTime:'',RBACUser_AccEndTime:'',RBACUser_Id:'',RBACUser_HREmployee_Id:'',RBACUser_HREmployee_DataTimeStamp:'',RBACUser_DataTimeStamp:'',RBACUser_AccLock:'',RBACUser_AuUnlock:''};Ext.typeOf(t)=='function'&&(s==''?alertError('没有获取到用户信息！'):t(s))}else alertError('获取应用信息失败！错误信息:'+r.ErrorInfo)},failure:function(e,t){alertError('获取应用信息请求失败！')}})},resetPassword:function(e,t){var n=this;Ext.Ajax.defaultPostHeader='application/json',Ext.Ajax.request({async:!1,url:n.resetPasswordUrl+'?Id='+e,method:'GET',timeout:2e3,success:function(e,t){var n=Ext.JSON.decode(e.responseText),r='';if(n.success)if(n.ResultDataValue&&n.ResultDataValue!=''){var i=Ext.JSON.decode(n.ResultDataValue);i.AccountPassword&&i.AccountPassword!=''&&(r=i.AccountPassword,alertInfo('您的新密码为：'+r))}else alertError('没有获取到应用信息！');else alertError('提示','获取应用信息失败！错误信息:'+n.ErrorInfo)},failure:function(e,t){alertError('获取应用信息请求失败！')}})},setParentIDComValue:function(e,t){var n=this,r=n.getComponent('yuangongListTab').getComponent('bumenTreeQuery'),i=n.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm'),s=i.getComponent('HREmployee_HRDept_Id');if(t=='add'){var o=i.getComponent('HREmployee_IsEnabled');o&&o!=undefined&&o.setValue('1')}var u=r.getSelectionModel().getSelection(),a=null;u&&u.length>0?a=u[0]:a=null;if(a&&a!=undefined&&a!=null&&s){var f=null;t=='add'?f=a:f=a.parentNode;var l='',c='';if(f&&f!=null){var h=f.data.Id;h==''||h==null?(l='',c=''):(l=h,c=f.data.text)}else l='',c='';var p=[[l,c]];s.store=Ext.create('Ext.data.SimpleStore',{fields:['value','text'],data:p,autoLoad:!0}),s.setValue(l)}},setDaptValue:function(e){var t=this,n=t.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm'),r=n.getComponent('HREmployee_HRDept_Id'),i=n.getComponent('HREmployee_BSex_Id'),s=null;e&&e!=undefined&&e!=null&&(s=e);if(i){var o={},u='';e.data['HREmployee_BSex_Name']=='男'&&(o={HREmployee_BSex_Id:['5350598518561423778']}),e.data['HREmployee_BSex_Name']=='女'&&(o={HREmployee_BSex_Id:['5480995475585737435']}),i.setValue(o)}if(r){var a=null;a=s;var f='',l='';if(a&&a!=null){var c=a.data.HREmployee_HRDept_Id;c==''||c==null?(f='',l=''):(f=c,l=a.data.HREmployee_HRDept_CName)}else f='',l='';var h=[[f,l]];r.store=Ext.create('Ext.data.SimpleStore',{fields:['value','text'],data:h,autoLoad:!0}),r.setValue(f)}},setPinYinZiTouValue:function(e){var t=this,n=function(e){var n=t.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm'),r=n.getComponent('HREmployee_PinYinZiTou');e!=''&&e!=null&&(e=e.replace(/ /g,'')),r&&r.setValue(e);var i=n.getComponent('HREmployee_Shortcode');i&&i.setValue(e)};if(e!='')getPinYinZiTouFromServer(e,n);else{var r=t.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm'),i=r.getComponent('HREmployee_PinYinZiTou');i&&i.setValue('');var s=r.getComponent('HREmployee_Shortcode');s&&s.setValue('')}},updateUserInfo:function(strobj,myUpdataUrl,mark){var me=this,myUrl='';myUpdataUrl!=''&&(myUrl=getRootPath()+'/'+myUpdataUrl);var values=strobj,maxLength=0;for(var i in values){var arr=i.split('_');arr.length>maxLength&&(maxLength=arr.length)}var obj={},addObj=function(key,num,value){var keyArr=key.split('_'),ob='obj',objSJC='';for(var i=1;i<keyArr.length;i++)ob=ob+'["'+keyArr[i]+'"]',objSJC=keyArr[i],eval(ob)||eval(ob+'={};');keyArr.length==num+1&&(objSJC=='DataTimeStamp'&&(value=value.split(',')),eval(ob+'=value;'))};for(var i=1;i<maxLength;i++)for(var j in values){var value=values[j];addObj(j,i,value)}var field='';if(maxLength==2)for(var i in values){var keyArr=i.split('_');field=field+keyArr[1]+','}field!=''&&(field=field.substring(0,field.length-1)),Ext.Ajax.defaultPostHeader='application/json',Ext.Ajax.request({async:!1,url:myUrl,params:Ext.JSON.encode({entity:obj,fields:field}),method:'POST',timeout:7e3,success:function(e,t){var n=Ext.JSON.decode(e.responseText);n.success?(mark==0&&alertInfo('保存成功！'),mark!=0&&alertInfo('您的新密码为：'+mark)):alertError('保存应用组件失败！错误信息:'+n.ErrorInfo)},failure:function(e,t){alertError('保存应用组件请求失败！')}})},getAppInfoFromServer:function(e,t){var n=this,r=n.getAppInfoServerUrl+'?isPlanish=true&id='+e;Ext.Ajax.defaultPostHeader='application/json',Ext.Ajax.request({async:!1,url:r,method:'GET',timeout:2e3,success:function(e,n){var r=Ext.JSON.decode(e.responseText);if(r.success){var i='';r.ResultDataValue&&r.ResultDataValue!=''&&(i=Ext.JSON.decode(r.ResultDataValue));if(Ext.typeOf(t)=='function'){var s={success:!1,ErrorInfo:'没有获取到应用组件信息!'};i!=''&&(s={success:!0,appInfo:i}),t(s)}}else if(Ext.typeOf(t)=='function'){var s={success:!1,ErrorInfo:'获取应用组件信息失败！错误信息:'+r.ErrorInfo};t(s)}},failure:function(e,n){if(Ext.typeOf(t)=='function'){var r={success:!1,ErrorInfo:'获取应用组件信息请求失败！'};t(r)}}})},doAddClick:function(){var e=this,t=e.getComponent('yuangongyuzhanghuTab').getComponent('yuangongxxForm'),n=e.getComponent('yuangongListTab').getComponent('bumenTreeQuery'),r=n?n.getSelectionModel().getSelection():null,i=r&&r.length==1?r[0]:null;if(i){var s={itemId:'HREmployee_HRDept_Id',Id:i.data.Id,Name:i.data.CName,DataTimeStamp:i.data.DataTimeStamp};t.setDataComboboxValue(s)}var o=t.getComponent('HREmployee_IsEnabled');o&&o!=undefined&&o.setValue('1')}})