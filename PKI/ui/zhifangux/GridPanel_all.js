Ext.ns("Ext.zhifangux");Ext.define("Ext.zhifangux.GridPanel",{extend:"Ext.grid.Panel",type:"gridpanel",alias:"widget.zhifanguxgridpanel",defaultWhere:"",internalWhere:"",externalWhere:"",autoSelect:true,deleteIndex:-1,defaultLoad:false,emptyText:"没有找到数据",sortconfig:null,defaultColumns:[],afterRender:function(){var me=this;me.callParent(arguments);me.store.on({beforeload:function(store,operation){me.beforeLoad(store,operation)},load:function(store,records,successful,eOpts){me.afterLoad(store,records,successful,eOpts)}});if(me.defaultLoad){me.load(true)}else{me.disableControl()}if(Ext.typeOf(me.callback)==="function"){me.callback(me)}},load:function(where){var me=this;if(where!==true){me.externalWhere=where}me.internalWhere=me.getInternalWhere();me.store.currentPage=1;me.store.load()},loadData:function(list){var me=this,pagingtoolbar=me.getComponent("pagingtoolbar"),l=list?list:[];me.beforeLoad();me.store.loadData(l);if(pagingtoolbar&&Ext.typeOf(pagingtoolbar.onLoad)=="function"){me.store.totalCount=l.length;pagingtoolbar.onLoad()}me.afterLoad(me.store,me.store.data.items,true)},changeData:function(response,bo){var me=this;var data=Ext.JSON.decode(response.responseText);var success=(data.success+""=="true"?true:false);if(!success){me.showError(data.ErrorInfo)}if(data.ResultDataValue&&data.ResultDataValue!=""){data.ResultDataValue=data.ResultDataValue.replace(/[\r\n]+/g,"");var ResultDataValue=Ext.JSON.decode(data.ResultDataValue);data.list=ResultDataValue.list;data.count=ResultDataValue.count}else{data.list=[];data.count=0}response.responseText=Ext.JSON.encode(data);bo&&me.setCount(data.count);return response},createStore:function(config){var me=this;var cfg={fields:config.fields,remoteSort:config.remoteSort,sorters:config.sorters,pageSize:config.PageSize,proxy:{type:"ajax",url:getRootPath()+"/"+config.url,reader:{type:"json",root:"list",totalProperty:"count"},extractResponseData:function(response){return me.changeData(response,config.hasCountToolbar)}}};if(config.buffered){cfg.buffered=config.buffered;cfg.leadingBufferZone=config.leadingBufferZone||config.PageSize}var store=Ext.create("Ext.data.Store",cfg);return store},getLoadUrl:function(){var me=this;var w="";if(me.externalWhere&&me.externalWhere!=""){if(me.externalWhere.slice(-1)=="^"){w+=me.externalWhere}else{w+="("+me.externalWhere+") and "}}if(me.defaultWhere&&me.defaultWhere!=""){w+="("+me.defaultWhere.replace(/\%25/g,"%").replace(/\%27/g,"'")+") and "}if(me.internalWhere&&me.internalWhere!=""){w+="("+me.internalWhere+") and "}w=w.slice(-5)==" and "?w.slice(0,-5):w;return me.url+"&where="+encodeString(w)},search:function(){this.load(true)},setCount:function(count){var me=this;var pagingtoolbar=me.getComponent("pagingtoolbar");if(pagingtoolbar){var com=pagingtoolbar.getComponent("count");if(com){var str="共"+count+"条";com.setText(str,false)}}},createColumns:function(){var me=this;var sortconfig=me.sortconfig;var columns=[];if(sortconfig){columns=me.getSortColumns()}else{columns=me.defaultColumns||[]}for(var i in columns){columns[i].doSort=function(state){var ds=this.up("tablepanel").store;me.defaultLoad&&ds.sort({property:this.getSortParam(),direction:state})}}return columns},getSortColumns:function(){var me=this;var sortconfig=me.sortconfig;var defaultColumns=me.defaultColumns;if(sortconfig){for(var i in defaultColumns){defaultColumns["OrderNum"]=sortconfig[defaultColumns[i]["dataIndex"]]["sort"]}}for(var i in defaultColumns){var kv={OrderNum:defaultColumns[i]["OrderNum"],Index:i};map.push(kv)}var map=[];for(var i=0;i<map.length-1;i++){for(var j=i+1;j<map.length;j++){if(map[i].OrderNum>map[j].OrderNum){var temp=map[i];map[i]=map[j];map[j]=temp}}}var list=[];for(var i in map){list.push(defaultColumns[map[i].Index])}return list},openFormWin:function(type,id,record){var me=this;var appId=me.openFormId||"";if(appId==""){alertError("没有配置弹出页面！")}else{var callback=function(info){if(info.success){var appInfo=info.appInfo;if(appInfo&&appInfo!=""){var ClassCode=appInfo["BTDAppComponents_ClassCode"];if(ClassCode&&ClassCode!=""){me.showFormWin(ClassCode,type,id,record)}else{alertError("没有类代码！")}}}else{alertError(info.ErrorInfo)}};getAppInfo(appId,callback,"BTDAppComponents_ClassCode")}},showFormWin:function(ClassCode,type,id,record){var me=this;var maxHeight=document.body.clientHeight*0.98-80;var maxWidth=document.body.clientWidth*0.98;var panelParams={type:type,maxWidth:maxWidth,dataId:id,selectionRecord:record,modal:true,floating:true,closable:true,resizable:true,draggable:true};ClassCode=ClassCode.replace(/@@/g,"\\'");var Class=eval(ClassCode);var panel=Ext.create(Class,panelParams);if(panel.height>maxHeight){panel.height=maxHeight}panel.show();panel.on({saveClick:function(){panel.close();me.load(true);me.fireEvent("saveClick")}});if(type=="add"){me.fireEvent("afterOpenAddWin",panel)}else{if(type=="edit"){me.fireEvent("afterOpenEditWin",panel)}else{if(type=="show"){me.fireEvent("afterOpenShowWin",panel)}}}},setModuleOperCookie:function(value){var v=value||"";Ext.util.Cookies.set("000660",v)
},showError:function(value){var me=this;var html="<center><b style='color:red;font-size:x-large'>"+value+"</b></center>";me.getView().update(html)},getInternalWhere:function(){var me=this,toolbar=me.getComponent("buttonstoolbar");var where="";if(toolbar){var searchText=toolbar.getComponent("searchText");if(searchText){var value=searchText.getValue();var searchArray=me.searchArray;if(value&&value!=""){for(var i in searchArray){if(searchArray[i].slice(-2)=="Id"){var bo=true;if(value.length>19){bo=false}else{bo=!isNaN(value)}if(bo){where+=searchArray[i]+"="+value+" or "}}else{where+=searchArray[i]+" like '%"+value+"%' or "}}where=where.length>0?"("+where.slice(0,-4)+")":""}}}return where},beforeLoad:function(store,operation){var me=this;me.disableControl();if(me.loaddata){me.setModuleOperCookie(me.loaddata)}me.store.proxy.url=me.getLoadUrl()},afterLoad:function(store,records,successful,eOpts){var me=this,autoSelect=me.autoSelect;if(!me.disableControlButton){me.enableControl()};me.setModuleOperCookie("");if(successful&&records.length>0){var num=-1;if(me.deleteIndex&&me.deleteIndex!=""&&me.deleteIndex!=-1){num=(records.length-1>me.deleteIndex)?me.deleteIndex:records.length-1}else{if(autoSelect){if(autoSelect===true){num=0}else{if(Ext.typeOf(autoSelect)==="string"){num=me.store.find(me.objectName+"_Id",autoSelect)}else{if(Ext.typeOf(autoSelect)==="number"){if(autoSelect>=0){num=autoSelect%records.length}else{num=length-Math.abs(num)%length}}}}}}me.deleteIndex=-1;if(num>=0){me.getSelectionModel().select(num)}}},enableControl:function(){var me=this,items=[],buttonstoolbar=me.getComponent("buttonstoolbar");pagingtoolbar=me.getComponent("pagingtoolbar");if(buttonstoolbar){items=items.concat(buttonstoolbar.items.items)}if(pagingtoolbar){items=items.concat(pagingtoolbar.items.items)}for(var i in items){items[i].enable()}me.defaultLoad=true},disableControl:function(){var me=this,items=[],buttonstoolbar=me.getComponent("buttonstoolbar");pagingtoolbar=me.getComponent("pagingtoolbar");if(buttonstoolbar){items=items.concat(buttonstoolbar.items.items)}if(pagingtoolbar){items=items.concat(pagingtoolbar.items.items)}for(var i in items){items[i].disable()}me.defaultLoad=false}});