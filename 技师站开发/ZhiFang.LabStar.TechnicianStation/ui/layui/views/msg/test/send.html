<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>危急值XML模拟上传</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<link rel="stylesheet" href="../../../../src/layui/src/css/layui.css" media="all">
	<link rel="shortcut icon" href="../../../../../logo-16.png">
</head>
<body class="layui-layout-body">
	<div class="layui-fluid">
		<div class="layui-card layui-form">
			<div class="layui-col-md12" style="margin:15px 0;">
				<textarea id="content" placeholder="请输入" class="layui-textarea" style="height:400px;"></textarea>
			</div>
			<div class="layui-col-md12" style="margin-bottom:15px">
				<button id="upload" class="layui-btn" style="float:right;">上传</button>
				<button id="uploadByPost" class="layui-btn" style="float:right;margin-right:10px;">消息post请求测试</button>
			</div>
		</div>
	</div>
	<script src="../../../../src/layui/src/layui.js"></script>
	<script type="text/javascript" src="../../../config/system.js"></script>
	<script>
		layui.extend({
			uxutil:'ux/util',
			msgintegrator:'modules/msg/integrator'
		}).use(['uxutil','msgintegrator', 'layer'],function(){
			var $=layui.$,
				uxutil = layui.uxutil,
				msgintegrator = layui.msgintegrator,
				UPLOAD_URL = uxutil.path.ROOT + '/ServerWCF/MsgManageService.svc/TestMsgSend'
			
			$("#upload").on("click",function(){
				onUpload();
			});
			//上传数据
			function onUpload(){
				var content = $("#content").val();
				
				uxutil.server.ajax({
					type: "post",
					data:JSON.stringify({"msg":content}),
					url:UPLOAD_URL,
				},function(data){
					layer.msg("上传成功");
				});
			}
			
			$(window).on("resize",function(){
				changeSize();
			});
			function changeSize(){
				var height = $(window).height(),
					buttonHeight = 28 + 30 + 14 + 25;
					
				$("#content").height(height - buttonHeight);
			}
			changeSize();
			
			
			$("#uploadByPost").on("click",function(){
				var loadIndex = layer.load();//开启加载层
				uxutil.server.ajax({
					type: "post",
					data:JSON.stringify({
						MessageInfo:"安徽省几点回家as回到家阿萨德",
						MessageType:"123",
						FormUserEmpId:"5239146706708216415",
						FormUserEmpName:"测试人员"
					}),
					url:uxutil.path.ROOT + '/ServerWCF/TestService.svc/SendCommMessages',
				},function(data){
					layer.close(loadIndex);//关闭加载层
					layer.msg("上传成功");
				});
			});
			
			var app = {};
			//初始化消息集成器
			app.initMsgintegrator = function(){
				var me = this;
				//启用消息集成器
				msgintegrator.init({
					//实例化正常后触发方法,instance:消息集成器实例
					done:function(instance){
						window.console && console.log && console.log("SEND消息集成器已准备就绪");
						//注册消息推送业务
						app.onRegisterMsg();
					},
					//实例化异常时触发方法,info:{code:'错误信息编码',msg:'错误信息概要',desc:'错误信息详细'}
					error:function(info){
						window.console && console.error && console.error(info.desc,info.msg);
					},
					//通信连接后触发,instance:消息集成器实例
					connected:{
						name:'text_' + new Date().getTime(),
						fun:function(instance){
							window.console && console.log && console.log("SEND通信连接成功");
						}
					},
					//通信连接断开后触发,返回尝试重连次数
					disconnected:{
						name:'text_' + new Date().getTime(),
						fun:function(reconnectCount){
							window.console && console.error && console.error("SEND通信中断");
						}
					}
				});
			};
			//注册消息推送业务
			app.onRegisterMsg = function(callback){
				var me = this;
				
				//注册消息业务
				msgintegrator.register({
					"name":'test_msg_' + new Date().getTime(),
					fun:function(MessageInfo,MessageType,FormUserEmpId,FormUserEmpName){
						window.console && console.log && console.log(new Date() + ": 【SEND】 = MessageInfo=" + MessageInfo + ";MessageType=" + MessageType + ";FormUserEmpId=" + FormUserEmpId + ";FormUserEmpName=" + FormUserEmpName);
					}
				});
				
				callback && callback();
			};
			app.initMsgintegrator();
		});
	</script>
</body>
</html>