<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>设置我的密码</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edgechrome=1">
	<meta name="viewport" content="width=device-width initial-scale=1.0 minimum-scale=1.0 maximum-scale=1.0 user-scalable=0">
	<script type="text/javascript">
		//加载版本号文件
		document.write("<script type='text/javascript' src='../../../../config/version.js?t=" + new Date().getTime() + "'><\/script>");
	</script>
	<link rel="stylesheet" href="../../../../../src/layui/dist/css/layui.css" media="all">
	<link rel="shortcut icon" href="../../../../../../logo-16.png">
</head>
<body>
	<div class="layui-fluid">
		<div class="layui-row layui-col-space15">
			<div class="layui-col-md12">
				<div class="layui-card">
					<div class="layui-card-header">修改密码</div>
					<div class="layui-card-body" pad15>
						<div class="layui-form" lay-filter="form">
							<div class="layui-form-item">
								<label class="layui-form-label">当前密码</label>
								<div class="layui-input-inline">
									<input type="password" name="oldPassword" id="oldPassword" lay-verify="required" lay-verType="tips" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">新密码</label>
								<div class="layui-input-inline">
									<input type="password" name="password" lay-verify="required|pass" lay-verType="tips" autocomplete="off" id="LAY_password" class="layui-input">
								</div>
								<div class="layui-form-mid layui-word-aux">6到16个字符</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label">确认新密码</label>
								<div class="layui-input-inline">
									<input type="password" name="repassword" lay-verify="required|repass" lay-verType="tips" autocomplete="off" class="layui-input">
								</div>
							</div>
							<div class="layui-form-item">
								<div class="layui-input-block">
									<button class="layui-btn" lay-submit lay-filter="setmypass">确认修改</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="../../../../../src/layui/dist/layui.js"></script>
	<script type="text/javascript">
		UIVersion.getJS('../../../../config/system.js');
	</script>
	<script type="text/javascript">
		layui.extend({
			uxutil:'ux/util',
		}).use(['uxutil','form'],function(){
			var $=layui.$,
				form = layui.form,
				uxutil = layui.uxutil;
				
			//校验用户名密码服务
			var LOGIN_SERVER_URL = uxutil.path.ROOT + '/ServerWCF/WebAssistManageService.svc/WA_BA_LoginValidate?isValidate=true';
			//修改服务地址
			var EDIT_URL = uxutil.path.ROOT + '/ServerWCF/WebAssistManageService.svc/WA_UDTO_UpdatePUserByField';
			
			//当前密码初始获得焦点
			$("#oldPassword").focus();
			form.on("submit(setmypass)",function(obj){
				var field = obj.field,
					oldPassword = field.oldPassword,
					password = field.password,
					repassword = field.repassword;
					
				if(password == ""){
					layer.msg("新密码不能为空!",{time:1000});
					return;
				}
				if(password != repassword){
					layer.msg("两次新密码密码不一致，请重新输入!",{time:1000});
					return;
				}
				if(password == oldPassword){
					layer.msg("新密码与当前密码相同，不需要修改!",{time:1000});
					return;
				}
				/* if(password =="123456"){
					layer.msg("新密不能为初始密码!",{time:1000});
					return;
				} */
				isValidate(oldPassword,function(){
					onEdit(password);
				});
			});
			//校验用户名密码
			function isValidate(password,callback){
				var url = LOGIN_SERVER_URL + '&strUserAccount=' + uxutil.cookie.get(uxutil.cookie.map.ACCOUNTNAME) + '&strPassWord=' + password;
				uxutil.server.ajax({
					url:url
				},function(result){
					if(result==true){
						callback();
					}else{
						layer.msg('当前密码错误！');
					}
				});
			};
			//密码修改提交
			function onEdit(password){
				var params = {
					entity:{
						Id:uxutil.cookie.get(uxutil.cookie.map.ACCOUNTID),
						Password:password
					},
					fields:'Id,Password'
				};
				uxutil.server.ajax({
					url:EDIT_URL,
					type:'post',
					data:JSON.stringify(params)
				},function(result){
					if(result.success){
						layer.msg('修改成功');
						form.val("form",{
							oldPassword:'',
							password:'',
							repassword:''
						});
					}else{
						layer.msg(result.msg);
					}
				},true);
			};
		});
	</script>
</body>
</html>